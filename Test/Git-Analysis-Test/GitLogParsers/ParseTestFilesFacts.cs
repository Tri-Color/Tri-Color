using System.Collections.Generic;
using Git_Analysis.Parsers;
using Xunit;

namespace Git_Analysis_Test.GitLogParsers
{
    public class ParseTestFilesFacts
    {
        [Theory]
        [InlineData("hash:a3aa3bf|addTime:2016-06-30|commitTime:2016-07-06| comment:[xiaonan] #1832 Remove feature toggle: tax-equalization and new-office-file-sharing ...ToggleTeqEqualicationAndNewOfficeFileSharing.cs |  20 ++++ Tiger/Tiger-Migration/Tiger-Migration.csproj       |   1 +.../pages/assignee/show/file-cabinet-upload.htm    | 110 ---------------------.../file-cabinet-upload-teq-to-mymoblity.htm       |   7 --.../show/accordion/tax-equalization.htm            |   2 -.../engagement/engagement-controller-spec.es6      |   2 - .../unit-test/spec/services/feature-toggle-spec.js |   9 +-7 files changed, 25 insertions(+), 126 deletions(-)"
            , "/engagement/engagement-controller-spec.es6,/unit-test/spec/services/feature-toggle-spec.js")]
        [InlineData("hash:f4b5364|addTime:2016-07-07|commitTime:2016-07-07| comment:[wangtao & chaohui] #8041 Type of Service drop down should list all countries .../type-of-services-controller.js                 | 24 ++++++++++------------.../type-of-services-controller-spec.es6           | 11 ++++++----2 files changed, 18 insertions(+), 17 deletions(-)",
            "/type-of-services-controller-spec.es6")]
        [InlineData(@"hash:8d4cdaf|addTime:2016-07-16|commitTime:2016-07-16| comment:[zq] #n/a test for sync for 3rd round---README.md | 2 ++1 file changed, 2 insertions(+) diff --git a/README.md b/README.mdindex ad6787e..d66ca87 100644--- a/README.md +++ b/README.md @@ -3,3 +3,5 @@ Tiger Source code repository for Project Tiger (replacement of Global Office and GlobalSTAR.Network)+Test+=====\ No newline at end of file",
            "")]
        [InlineData(@"hash:5ede621|addTime:2016-07-14|commitTime:2016-07-15| comment:[wangjian & tubiao] #1888 Add comments info when get immigration missing items. ---  .../Pacts/immigration-missing-information-tigerapi.json   |  6 +++++-  .../myMobilityApps/ImmigrationMissingInformationFacts.cs  |  2 +-  .../Fixtures/DummyMissingItem/MissingItemBuilder.cs       |  9 +++++++--  .../when_get_immigration_missing_info.cs                  | 15 ++++++++++++---  .../MyMobilityImmigrationMissingInfoController.cs         | 11 +++++++++--  .../ImmigrationApplicationWorkRecordRepository.cs         |  6 ++++++  6 files changed, 40 insertions(+), 9 deletions(-)  diff --git a/Test/Tiger-Contract-Test-By-Consumer/Pacts/immigration-missing-information-tigerapi.json b/Test/Tiger-Contract-Test-By-Consumer/Pacts/immigration-missing-information-tigerapi.json index 94442aa..cd39ee1 100644 --- a/Test/Tiger-Contract-Test-By-Consumer/Pacts/immigration-missing-information-tigerapi.json +++ b/Test/Tiger-Contract-Test-By-Consumer/Pacts/immigration-missing-information-tigerapi.json @@ -30,6 +30,7 @@          },          body: [            { +            id: 1,              employeeFirstName: Adette,              assigneeId: 1,              employeeLastName: Jia, @@ -41,7 +42,10 @@              dateIdentified: 2016-01-01,              workRecordStatus: No Issues,              from: Client, -            description: missing info +            description: missing info, +            comments: Comments, +            commentsAt: 2016-07-14T00:00:00, +            commentsBy: CommentsBy            }          ]        } diff --git a/Test/Tiger-Contract-Test-By-Consumer/myMobilityApps/ImmigrationMissingInformationFacts.cs b/Test/Tiger-Contract-Test-By-Consumer/myMobilityApps/ImmigrationMissingInformationFacts.cs index 98efaeb..1f3071d 100644 --- a/Test/Tiger-Contract-Test-By-Consumer/myMobilityApps/ImmigrationMissingInformationFacts.cs +++ b/Test/Tiger-Contract-Test-By-Consumer/myMobilityApps/ImmigrationMissingInformationFacts.cs @@ -34,7 +34,7 @@ private void GivenMissingInformationRequest()              var workRecord = CreateImmigrationApplicationWorkRecord();                var missingItems = new List<MissingItem> { -                MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing info, new DateTime(2016, 1, 1), workRecord.ImmigrationApplications[0]), +                MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing info, new DateTime(2016, 1, 1), workRecord.ImmigrationApplications[0], Comments, CommentsBy, new DateTime(2016,7,14))              };              MissingItemBuilder.Create(missingItems);          } diff --git a/Test/Tiger-Core-Test/Fixtures/DummyMissingItem/MissingItemBuilder.cs b/Test/Tiger-Core-Test/Fixtures/DummyMissingItem/MissingItemBuilder.cs index 2546e5f..80a563b 100644 --- a/Test/Tiger-Core-Test/Fixtures/DummyMissingItem/MissingItemBuilder.cs +++ b/Test/Tiger-Core-Test/Fixtures/DummyMissingItem/MissingItemBuilder.cs @@ -17,9 +17,14 @@ public static List<MissingItem> Create(List<MissingItem> missingItems)              return missingItems.Select(m => missingItemRepository.Create(m)).ToList();          }   -        public static MissingItem CreateMissingItemWithApplication(long workRecordId, string from, string description, DateTime since, ImmigrationApplication application) +        public static MissingItem CreateMissingItemWithApplication(long workRecordId, string from, string description, DateTime since, ImmigrationApplication application, string comments = , string commentsBy = , DateTime? commentsAt = null)          { -            var item = new MissingItem(workRecordId, from, description, since); +            var item = new MissingItem(workRecordId, from, description, since) +            { +                Comments = comments, +                CommentsBy = commentsBy, +                CommentsAt = commentsAt +            };              item.AssignApplication(application);              return item;          } diff --git a/Test/Tiger-Core-Test/ResourceTests/MyMobilitySpec/ImmigrationMissingInfo/when_get_immigration_missing_info.cs b/Test/Tiger-Core-Test/ResourceTests/MyMobilitySpec/ImmigrationMissingInfo/when_get_immigration_missing_info.cs index c02df5b..de5415b 100644 --- a/Test/Tiger-Core-Test/ResourceTests/MyMobilitySpec/ImmigrationMissingInfo/when_get_immigration_missing_info.cs +++ b/Test/Tiger-Core-Test/ResourceTests/MyMobilitySpec/ImmigrationMissingInfo/when_get_immigration_missing_info.cs @@ -211,9 +211,9 @@ public class when_get_company_missing_info              Establish given_company_missing_infos = () =>              {                  missingItems = new List<MissingItem> { -                    MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing item 1, DateTime.UtcNow, workRecord.ImmigrationApplications[0]), -                    MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing item 2, DateTime.UtcNow.AddDays(-5), workRecord.ImmigrationApplications[0]), -                    MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing item 3, DateTime.UtcNow.AddDays(-10), workRecord.ImmigrationApplications[1]) +                    MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing item 1, DateTime.UtcNow, workRecord.ImmigrationApplications[0], Comments), +                    MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing item 2, DateTime.UtcNow.AddDays(-5), workRecord.ImmigrationApplications[0], Comments, Nancy), +                    MissingItemBuilder.CreateMissingItemWithApplication(workRecord.Id, MissingItemFrom.Client, missing item 3, DateTime.UtcNow.AddDays(-10), workRecord.ImmigrationApplications[1], Comments, Nancy, DateTime.UtcNow.Date)                  };                  MissingItemBuilder.Create(missingItems);              }; @@ -245,6 +245,9 @@ public class when_get_company_missing_info                  companyMissingInfo[0].ServiceName.ShouldEqual(workRecord.Core.PrimaryService.Description);                  companyMissingInfo[0].DateIdentified.ShouldEqual(DateTime.UtcNow.ToIsoDateString());                  companyMissingInfo[0].Description.ShouldEqual(missing item 1); +                companyMissingInfo[0].Comments.ShouldEqual(missingItems[0].Comments); +                companyMissingInfo[0].CommentsBy.ShouldEqual(missingItems[0].CommentsBy); +                companyMissingInfo[0].CommentsAt.ShouldEqual(missingItems[0].CommentsAt);                    companyMissingInfo[1].Id.ShouldEqual(missingItems[1].Id);                  companyMissingInfo[1].EmployeeFirstName.ShouldEqual(adetteForImmigration.Name.FirstName); @@ -257,6 +260,9 @@ public class when_get_company_missing_info                  companyMissingInfo[1].ServiceName.ShouldEqual(workRecord.Core.PrimaryService.Description);                  companyMissingInfo[1].DateIdentified.ShouldEqual(DateTime.UtcNow.AddDays(-5).ToIsoDateString());                  companyMissingInfo[1].Description.ShouldEqual(missing item 2); +                companyMissingInfo[1].Comments.ShouldEqual(missingItems[1].Comments); +                companyMissingInfo[1].CommentsBy.ShouldEqual(missingItems[1].CommentsBy); +                companyMissingInfo[1].CommentsAt.ShouldEqual(missingItems[1].CommentsAt);                    companyMissingInfo[2].Id.ShouldEqual(missingItems[2].Id);                  companyMissingInfo[2].EmployeeFirstName.ShouldEqual(adetteForImmigration.Name.FirstName); @@ -269,6 +275,9 @@ public class when_get_company_missing_info                  companyMissingInfo[2].ServiceName.ShouldEqual(workRecord.AdditionalServices[0].TypeOfService.Description);                  companyMissingInfo[2].DateIdentified.ShouldEqual(DateTime.UtcNow.AddDays(-10).ToIsoDateString());                  companyMissingInfo[2].Description.ShouldEqual(missing item 3); +                companyMissingInfo[2].Comments.ShouldEqual(missingItems[2].Comments); +                companyMissingInfo[2].CommentsBy.ShouldEqual(missingItems[2].CommentsBy); +                companyMissingInfo[2].CommentsAt.ShouldEqual(missingItems[2].CommentsAt);              };          }   diff --git a/Tiger/Tiger-API/Resources/MyMobility/MyMobilityImmigrationMissingInfoController.cs b/Tiger/Tiger-API/Resources/MyMobility/MyMobilityImmigrationMissingInfoController.cs index 56dbdae..50c509c 100644 --- a/Tiger/Tiger-API/Resources/MyMobility/MyMobilityImmigrationMissingInfoController.cs +++ b/Tiger/Tiger-API/Resources/MyMobility/MyMobilityImmigrationMissingInfoController.cs @@ -1,4 +1,5 @@ -∩╗┐using System.Collections.Generic; +∩╗┐using System; +using System.Collections.Generic;  using System.Linq;  using System.Net;  using System.Net.Http; @@ -71,7 +72,10 @@ public HttpResponseMessage GetImmigrationMissingInfo(MobilityRequestWithUdfFilte                      DateIdentified = mi.DateIdentified.ToIsoDateString(),                      WorkRecordStatus = mi.WorkRecordStatus.ToDescription(),                      From = mi.From, -                    Description = mi.From == MissingItemFrom.Assignee ? null : mi.Description +                    Description = mi.From == MissingItemFrom.Assignee ? null : mi.Description, +                    Comments = mi.Comments, +                    CommentsBy = mi.CommentsBy, +                    CommentsAt = mi.CommentsAt                  })                  .ToList();               @@ -105,5 +109,8 @@ public class ImmigrationMissingInfoDto          public string Description { get; set; }          public long AssigneeId { get; set; }          public long Id { get; set; } +        public string Comments { get; set; } +        public string CommentsBy { get; set; } +        public DateTime? CommentsAt { get; set; }      }  } diff --git a/Tiger/Tiger.Domain.Core/WorkRecords/ImmigrationApplicationWorkRecordRepository.cs b/Tiger/Tiger.Domain.Core/WorkRecords/ImmigrationApplicationWorkRecordRepository.cs index 4cc645a..c436a8c 100644 --- a/Tiger/Tiger.Domain.Core/WorkRecords/ImmigrationApplicationWorkRecordRepository.cs +++ b/Tiger/Tiger.Domain.Core/WorkRecords/ImmigrationApplicationWorkRecordRepository.cs @@ -30,6 +30,9 @@ public List<MissingItemWithImmigrationWorkRecord> GetImmigrationMissingItemsWith                          mi.Since as DateIdentified,                          mi.From as From,                          mi.Description as Description, +                        mi.Comments as Comments, +                        mi.CommentsBy as CommentsBy, +                        mi.CommentsAt as CommentsAt,                          wr.ServiceStatus as WorkRecordStatus,                          coalesce(service.Id, -1) as ServiceId,                          service.Description as ServiceName @@ -62,5 +65,8 @@ public class MissingItemWithImmigrationWorkRecord          public string Description { get; set; }          public long ServiceId { get; set; }          public string ServiceName { get; set; } +        public string Comments { get; set; } +        public string CommentsBy { get; set; } +        public DateTime? CommentsAt { get; set; }      }  } \ No newline at end of file",
            "/Test/Tiger-Core-Test/ResourceTests/MyMobilitySpec/ImmigrationMissingInfo/when_get_immigration_missing_info.cs," +
                "/Test/Tiger-Contract-Test-By-Consumer/myMobilityApps/ImmigrationMissingInformationFacts.cs")]
        public void should_parse_test_files_from_commit_information(string commitInfo, string testFiles)
        {
            TestFilesParser parser = new TestFilesParser();
            parser.parse(commitInfo);
            HashSet<string> changedtestFiles = (HashSet<string>) parser.TestFiles;
            foreach (var testfile in testFiles.Split(','))
            {
                if (testfile.Equals(""))
                {
                    Assert.Equal(changedtestFiles.Count, 0);
                }
                else
                {
                    Assert.True(changedtestFiles.Contains(testfile));
                }
            }
        }
    }
}